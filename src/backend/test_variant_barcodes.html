<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Sistema de C√≥digos de Barras por Variante</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h1,
      h2 {
        color: #333;
        text-align: center;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      .barcode-container {
        margin: 15px 0;
        padding: 10px;
        border: 2px dashed #ccc;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .error {
        color: red;
        background-color: #ffe6e6;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .success {
        color: green;
        background-color: #e6ffe6;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      input,
      select {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
        width: 150px;
      }
      .variant-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .variant-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: #f9f9f9;
      }
      .variant-info {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
      }
      .barcode-code {
        font-family: monospace;
        font-size: 12px;
        color: #444;
        word-break: break-all;
        margin: 5px 0;
      }
      .parse-result {
        background: #f0f8ff;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üè∑Ô∏è Test Sistema de C√≥digos de Barras por Variante</h1>
      <p style="text-align: center; color: #666">
        Sistema completo para generar c√≥digos √∫nicos por talle y color de cada producto
      </p>
    </div>

    <div class="container">
      <div class="test-section">
        <h3>1. Test General del Servicio</h3>
        <button onclick="testService()">Probar Servicio</button>
        <div id="general-result"></div>
        <div id="general-barcode" class="barcode-container"></div>
      </div>

      <div class="test-section">
        <h3>2. Generar C√≥digos para Producto Completo</h3>
        <div>
          <label>ID del Producto:</label>
          <input type="number" id="product-id" value="1" placeholder="Ej: 1" />
          <button onclick="generateProductVariants()">Generar Todas las Variantes</button>
        </div>
        <div id="product-result"></div>
        <div id="product-variants" class="variant-grid"></div>
      </div>

      <div class="test-section">
        <h3>3. Generar Variante Espec√≠fica</h3>
        <div>
          <label>Producto:</label>
          <input type="number" id="single-product-id" value="1" placeholder="ID Producto" />
          <label>Talle:</label>
          <input type="number" id="size-id" value="1" placeholder="ID Talle" />
          <label>Color:</label>
          <input type="number" id="color-id" value="1" placeholder="ID Color" />
          <button onclick="generateSingleVariant()">Generar Variante</button>
        </div>
        <div id="single-result"></div>
        <div id="single-barcode" class="barcode-container"></div>
      </div>

      <div class="test-section">
        <h3>4. Parsear C√≥digo de Barras</h3>
        <div>
          <label>C√≥digo de Barras:</label>
          <input
            type="text"
            id="parse-barcode"
            value="VAR0001001002"
            placeholder="Ej: VAR0001001002"
          />
          <button onclick="parseBarcode()">Parsear C√≥digo</button>
        </div>
        <div id="parse-result"></div>
      </div>

      <div class="test-section">
        <h3>5. Simular Creaci√≥n de Producto con Variantes</h3>
        <p>Este test simula el flujo completo de crear un producto con m√∫ltiples variantes:</p>
        <button onclick="simulateProductCreation()">Simular Creaci√≥n Completa</button>
        <div id="simulation-result"></div>
        <div id="simulation-variants" class="variant-grid"></div>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:5000/api/barcode'

      // Test general del servicio
      async function testService() {
        const resultDiv = document.getElementById('general-result')
        const barcodeDiv = document.getElementById('general-barcode')

        try {
          resultDiv.innerHTML = '<div>üîÑ Probando servicio...</div>'

          const response = await fetch(`${API_BASE}/test`)
          const data = await response.json()

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ ${data.message}<br>
                            <strong>C√≥digo de producto:</strong> ${data.test_product_code}<br>
                            <strong>C√≥digo de variante:</strong> ${data.test_variant_code}
                        </div>
                    `

            barcodeDiv.innerHTML = `
                        <div style="margin: 10px;">
                            <h4>C√≥digo de Producto:</h4>
                            ${data.product_barcode_svg}
                        </div>
                        <div style="margin: 10px;">
                            <h4>C√≥digo de Variante:</h4>
                            ${data.variant_barcode_svg}
                        </div>
                        <div class="parse-result">
                            <strong>Datos parseados del c√≥digo de variante:</strong><br>
                            Producto ID: ${data.parsed_variant.product_id}<br>
                            Talle ID: ${data.parsed_variant.size_id || 'N/A'}<br>
                            Color ID: ${data.parsed_variant.color_id || 'N/A'}
                        </div>
                    `
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
          console.error('Error:', error)
        }
      }

      // Generar variantes para un producto
      async function generateProductVariants() {
        const productId = document.getElementById('product-id').value
        const resultDiv = document.getElementById('product-result')
        const variantsDiv = document.getElementById('product-variants')

        if (!productId) {
          resultDiv.innerHTML = '<div class="error">‚ùå Ingresa un ID de producto</div>'
          return
        }

        try {
          resultDiv.innerHTML = '<div>üîÑ Generando variantes...</div>'

          // Simular variantes de ejemplo
          const exampleVariants = [
            { size_id: 1, color_id: 1 }, // Talle S, Color Rojo
            { size_id: 1, color_id: 2 }, // Talle S, Color Azul
            { size_id: 2, color_id: 1 }, // Talle M, Color Rojo
            { size_id: 2, color_id: 2 }, // Talle M, Color Azul
            { size_id: 3, color_id: 1 } // Talle L, Color Rojo
          ]

          const response = await fetch(`${API_BASE}/generate-variants`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              product_id: parseInt(productId),
              variants: exampleVariants
            })
          })

          const data = await response.json()

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Generadas ${data.variants_count} variantes para producto #${data.product_id}
                        </div>
                    `

            // Mostrar cada variante
            variantsDiv.innerHTML = data.variant_barcodes
              .map(
                (variant) => `
                        <div class="variant-card">
                            <div class="variant-info">
                                <strong>Producto:</strong> ${variant.product_id} | 
                                <strong>Talle:</strong> ${variant.size_id || 'N/A'} | 
                                <strong>Color:</strong> ${variant.color_id || 'N/A'}
                            </div>
                            <div class="barcode-code">${variant.barcode}</div>
                            <div style="text-align: center; margin: 10px 0;">
                                ${variant.barcode_svg}
                            </div>
                        </div>
                    `
              )
              .join('')
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
          console.error('Error:', error)
        }
      }

      // Generar variante espec√≠fica
      async function generateSingleVariant() {
        const productId = document.getElementById('single-product-id').value
        const sizeId = document.getElementById('size-id').value
        const colorId = document.getElementById('color-id').value
        const resultDiv = document.getElementById('single-result')
        const barcodeDiv = document.getElementById('single-barcode')

        if (!productId) {
          resultDiv.innerHTML = '<div class="error">‚ùå Ingresa un ID de producto</div>'
          return
        }

        try {
          resultDiv.innerHTML = '<div>üîÑ Generando variante...</div>'

          const response = await fetch(`${API_BASE}/generate-variant`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              product_id: parseInt(productId),
              size_id: sizeId ? parseInt(sizeId) : null,
              color_id: colorId ? parseInt(colorId) : null
            })
          })

          const data = await response.json()

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Variante generada<br>
                            <strong>Producto:</strong> ${data.product_id}<br>
                            <strong>Talle:</strong> ${data.size_id || 'N/A'}<br>
                            <strong>Color:</strong> ${data.color_id || 'N/A'}<br>
                            <strong>C√≥digo:</strong> ${data.variant_barcode}
                        </div>
                    `
            barcodeDiv.innerHTML = data.barcode_svg
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
          console.error('Error:', error)
        }
      }

      // Parsear c√≥digo de barras
      async function parseBarcode() {
        const barcode = document.getElementById('parse-barcode').value
        const resultDiv = document.getElementById('parse-result')

        if (!barcode) {
          resultDiv.innerHTML = '<div class="error">‚ùå Ingresa un c√≥digo de barras</div>'
          return
        }

        try {
          const response = await fetch(`${API_BASE}/parse-variant/${barcode}`)
          const data = await response.json()

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ C√≥digo parseado exitosamente<br>
                            <strong>C√≥digo original:</strong> ${data.barcode}<br>
                            <div class="parse-result">
                                <strong>Datos extra√≠dos:</strong><br>
                                ‚Ä¢ Producto ID: ${data.parsed.product_id}<br>
                                ‚Ä¢ Talle ID: ${data.parsed.size_id || 'No especificado'}<br>
                                ‚Ä¢ Color ID: ${data.parsed.color_id || 'No especificado'}
                            </div>
                        </div>
                    `
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`
          console.error('Error:', error)
        }
      }

      // Simular creaci√≥n completa de producto
      async function simulateProductCreation() {
        const resultDiv = document.getElementById('simulation-result')
        const variantsDiv = document.getElementById('simulation-variants')

        try {
          resultDiv.innerHTML = '<div>üîÑ Simulando creaci√≥n de producto...</div>'

          // Simular que se cre√≥ un producto con ID 999
          const mockProductId = 999

          // Simular estructura de talles como en el frontend
          const mockTalles = [
            {
              talle: 'S',
              colores: [
                { color: 'Rojo', cantidad: '5' },
                { color: 'Azul', cantidad: '3' }
              ]
            },
            {
              talle: 'M',
              colores: [
                { color: 'Rojo', cantidad: '8' },
                { color: 'Verde', cantidad: '2' }
              ]
            },
            {
              talle: 'L',
              colores: [
                { color: 'Azul', cantidad: '4' },
                { color: 'Negro', cantidad: '6' }
              ]
            }
          ]

          // Convertir a formato de variantes
          const variants = []
          let sizeIdCounter = 1
          let colorIdCounter = 1
          const sizeMap = {}
          const colorMap = {}

          mockTalles.forEach((talle) => {
            if (!sizeMap[talle.talle]) {
              sizeMap[talle.talle] = sizeIdCounter++
            }

            talle.colores.forEach((color) => {
              if (!colorMap[color.color]) {
                colorMap[color.color] = colorIdCounter++
              }

              if (parseInt(color.cantidad) > 0) {
                variants.push({
                  size_id: sizeMap[talle.talle],
                  color_id: colorMap[color.color],
                  quantity: parseInt(color.cantidad),
                  size_name: talle.talle,
                  color_name: color.color
                })
              }
            })
          })

          resultDiv.innerHTML = `
                    <div class="success">
                        üéâ Producto simulado creado con ID: ${mockProductId}<br>
                        üìä Encontradas ${variants.length} variantes v√°lidas<br>
                        üîÑ Generando c√≥digos de barras...
                    </div>
                `

          // Generar c√≥digos para todas las variantes
          const response = await fetch(`${API_BASE}/generate-variants`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              product_id: mockProductId,
              variants: variants
            })
          })

          const data = await response.json()

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Simulaci√≥n completada exitosamente<br>
                            üì¶ Producto ID: ${mockProductId}<br>
                            üè∑Ô∏è C√≥digos generados: ${data.variants_count}<br>
                            üìä Variantes procesadas: ${variants.length}
                        </div>
                    `

            // Mostrar cada variante con informaci√≥n detallada
            variantsDiv.innerHTML = data.variant_barcodes
              .map((variant, index) => {
                const originalVariant = variants[index]
                return `
                            <div class="variant-card">
                                <div class="variant-info">
                                    <strong>${originalVariant.size_name}</strong> - 
                                    <strong>${originalVariant.color_name}</strong><br>
                                    Cantidad: ${originalVariant.quantity} unidades<br>
                                    IDs: Producto ${variant.product_id} | Talle ${variant.size_id} | Color ${variant.color_id}
                                </div>
                                <div class="barcode-code">${variant.barcode}</div>
                                <div style="text-align: center; margin: 10px 0;">
                                    ${variant.barcode_svg}
                                </div>
                            </div>
                        `
              })
              .join('')
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå Error en simulaci√≥n: ${data.error}</div>`
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå Error en simulaci√≥n: ${error.message}</div>`
          console.error('Error:', error)
        }
      }

      // Auto-cargar test b√°sico
      window.onload = function () {
        console.log('üöÄ Sistema de test cargado. Servidor debe estar en http://localhost:5000')
      }
    </script>
  </body>
</html>
