<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test de Login - Mykonos</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      input {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Test de Login - Mykonos OS</h1>

      <div>
        <h3>Informaci√≥n del Sistema:</h3>
        <div id="system-info" class="log"></div>
      </div>

      <div>
        <h3>Test de Login:</h3>
        <input type="text" id="username" value="admin" placeholder="Usuario" />
        <input type="password" id="password" value="admin123" placeholder="Contrase√±a" />
        <button onclick="testLogin()">üîë Probar Login</button>
        <button onclick="testValidation()">‚úÖ Probar Validaci√≥n</button>
        <button onclick="clearSession()">üßπ Limpiar Sesi√≥n</button>
      </div>

      <div>
        <h3>Logs:</h3>
        <div id="logs" class="log"></div>
      </div>
    </div>

    <script>
      // Funciones de logging
      function log(message, type = 'info') {
        const logs = document.getElementById('logs')
        const timestamp = new Date().toLocaleTimeString()
        const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'
        logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`
        logs.scrollTop = logs.scrollHeight
        console.log(`[${timestamp}] ${message}`)
      }

      // Informaci√≥n del sistema
      function updateSystemInfo() {
        const info = document.getElementById('system-info')
        const sessionToken = localStorage.getItem('session_token')
        info.innerHTML = `
                <strong>Estado del navegador:</strong><br>
                - Session Token: ${sessionToken ? sessionToken.substring(0, 20) + '...' : 'No existe'}<br>
                - Local Storage: ${Object.keys(localStorage).length} elementos<br>
                - URL Actual: ${window.location.href}<br>
                - User Agent: ${navigator.userAgent.substring(0, 50)}...
            `
      }

      // Test de login
      async function testLogin() {
        const username = document.getElementById('username').value
        const password = document.getElementById('password').value

        log('üîÑ Iniciando test de login...', 'info')
        log(`Usuario: ${username}`, 'info')

        try {
          const response = await fetch('http://localhost:5000/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: username,
              password: password,
              storage_id: null // Sin sucursal para admin
            })
          })

          const data = await response.json()
          log(`Respuesta del servidor: ${response.status}`, 'info')

          if (data.success) {
            log('‚úÖ Login exitoso!', 'success')
            log(`Token: ${data.session_data.session_token.substring(0, 20)}...`, 'success')
            log(`Usuario: ${data.session_data.username}`, 'success')
            log(`Rol: ${data.session_data.role}`, 'success')

            // Guardar token
            localStorage.setItem('session_token', data.session_data.session_token)
            log('üíæ Token guardado en localStorage', 'success')

            updateSystemInfo()
          } else {
            log(`‚ùå Login fall√≥: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`üö® Error de conexi√≥n: ${error.message}`, 'error')
        }
      }

      // Test de validaci√≥n
      async function testValidation() {
        const sessionToken = localStorage.getItem('session_token')

        if (!sessionToken) {
          log('‚ùå No hay token de sesi√≥n. Haz login primero.', 'error')
          return
        }

        log('üîÑ Probando validaci√≥n de sesi√≥n...', 'info')

        try {
          const response = await fetch('http://localhost:5000/api/auth/validate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              session_token: sessionToken
            })
          })

          const data = await response.json()
          log(`Respuesta de validaci√≥n: ${response.status}`, 'info')

          if (data.success) {
            log('‚úÖ Validaci√≥n exitosa!', 'success')
            log(`Usuario: ${data.session_data.username}`, 'success')
            log(`Rol: ${data.session_data.role}`, 'success')
            log(`Sucursal: ${data.session_data.storage_name}`, 'success')
          } else {
            log(`‚ùå Validaci√≥n fall√≥: ${data.message}`, 'error')
            // Limpiar token inv√°lido
            localStorage.removeItem('session_token')
            updateSystemInfo()
          }
        } catch (error) {
          log(`üö® Error en validaci√≥n: ${error.message}`, 'error')
        }
      }

      // Limpiar sesi√≥n
      function clearSession() {
        localStorage.removeItem('session_token')
        log('üßπ Token de sesi√≥n eliminado', 'info')
        updateSystemInfo()
      }

      // Test autom√°tico al cargar
      async function autoTest() {
        log('üöÄ Iniciando test autom√°tico...', 'info')
        updateSystemInfo()

        // Verificar conexi√≥n con backend
        try {
          const response = await fetch('http://localhost:5000/api/auth/storages')
          if (response.ok) {
            log('‚úÖ Conexi√≥n con backend: OK', 'success')
          } else {
            log(`‚ö†Ô∏è Backend responde pero con error: ${response.status}`, 'error')
          }
        } catch (error) {
          log('üö® No se puede conectar al backend', 'error')
          log('Verifica que el servidor est√© corriendo en puerto 5000', 'error')
        }
      }

      // Ejecutar al cargar la p√°gina
      window.onload = function () {
        autoTest()

        // Actualizar info cada 5 segundos
        setInterval(updateSystemInfo, 5000)
      }
    </script>
  </body>
</html>
